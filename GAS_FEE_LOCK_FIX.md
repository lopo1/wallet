# Gas è´¹ç”¨é”å®šä¿®å¤

## é—®é¢˜æè¿°

ç”¨æˆ·ç‚¹å‡»"å…¨éƒ¨"æŒ‰é’®åï¼Œç‚¹å‡»"ä¸‹ä¸€æ­¥"ä»ç„¶æç¤ºä½™é¢ä¸è¶³ã€‚

**æ ¹æœ¬åŸå› **ï¼š
Gas è´¹ç”¨æ¯8ç§’è‡ªåŠ¨åˆ·æ–°ã€‚å½“ç”¨æˆ·ç‚¹å‡»"å…¨éƒ¨"åï¼Œå¦‚æœ Gas è´¹ç”¨åœ¨ç”¨æˆ·ç‚¹å‡»"ä¸‹ä¸€æ­¥"ä¹‹å‰å‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šå¯¼è‡´ï¼š
- åŸå§‹è®¡ç®—ï¼šé‡‘é¢ = ä½™é¢ - Gasè´¹A
- éªŒè¯æ—¶ï¼šé‡‘é¢ + Gasè´¹B > ä½™é¢ï¼ˆå¦‚æœ Gasè´¹B > Gasè´¹Aï¼‰

## è§£å†³æ–¹æ¡ˆ

### 1. æ·»åŠ  Gas è´¹ç”¨é”å®šæ ‡å¿—

```dart
bool _gasFeeLocked = false; // Gas è´¹ç”¨é”å®šæ ‡å¿—
```

### 2. ç‚¹å‡»"å…¨éƒ¨"æ—¶é”å®š Gas è´¹ç”¨

```dart
void _setMaxAmount() {
  // ... è®¡ç®—æœ€å¤§é‡‘é¢ ...
  
  setState(() {
    _amountController.text = AmountUtils.format(maxAmountDecimal);
    _gasFeeLocked = true; // é”å®š Gas è´¹ç”¨
    errorMessage = '';
  });
  
  debugPrint('Gas è´¹ç”¨å·²é”å®š');
}
```

### 3. Gas åˆ·æ–°å®šæ—¶å™¨æ£€æŸ¥é”å®šçŠ¶æ€

```dart
void _startGasRefreshTimer() {
  // å€’è®¡æ—¶å®šæ—¶å™¨
  _countdownTimer = Timer.periodic(const Duration(seconds: 1), (timer) {
    if (!_gasFeeLocked) { // åªåœ¨æœªé”å®šæ—¶æ›´æ–°
      setState(() {
        _gasRefreshCountdown--;
      });
      
      if (_gasRefreshCountdown <= 0) {
        _loadGasFee();
        // ...
      }
    }
  });
  
  // ä¸»åˆ·æ–°å®šæ—¶å™¨
  _gasRefreshTimer = Timer.periodic(const Duration(seconds: 8), (timer) {
    if (!_gasFeeLocked) { // åªåœ¨æœªé”å®šæ—¶åˆ·æ–°
      _loadGasFee();
      // ...
    }
  });
}
```

### 4. ç”¨æˆ·ä¿®æ”¹é‡‘é¢æ—¶è§£é”

```dart
TextField(
  controller: _amountController,
  onChanged: (value) {
    // è§£é” Gas è´¹ç”¨
    setState(() {
      _gasFeeLocked = false;
    });
    _loadGasFee();
  },
)
```

## å·¥ä½œæµç¨‹

### åœºæ™¯1ï¼šæ­£å¸¸ä½¿ç”¨

1. ç”¨æˆ·æ‰“å¼€å‘é€é¡µé¢
2. Gas è´¹ç”¨æ¯8ç§’è‡ªåŠ¨åˆ·æ–° âœ…
3. ç”¨æˆ·è¾“å…¥é‡‘é¢
4. Gas è´¹ç”¨ç»§ç»­åˆ·æ–° âœ…
5. ç”¨æˆ·ç‚¹å‡»"ä¸‹ä¸€æ­¥"
6. éªŒè¯é€šè¿‡ âœ…

### åœºæ™¯2ï¼šä½¿ç”¨"å…¨éƒ¨"æŒ‰é’®

1. ç”¨æˆ·æ‰“å¼€å‘é€é¡µé¢
2. Gas è´¹ç”¨æ¯8ç§’è‡ªåŠ¨åˆ·æ–° âœ…
3. ç”¨æˆ·ç‚¹å‡»"å…¨éƒ¨"
4. è®¡ç®—æœ€å¤§é‡‘é¢ = ä½™é¢ - Gasè´¹
5. **Gas è´¹ç”¨è¢«é”å®š** ğŸ”’
6. ç”¨æˆ·ç­‰å¾…ï¼ˆGas è´¹ç”¨ä¸å†åˆ·æ–°ï¼‰
7. ç”¨æˆ·ç‚¹å‡»"ä¸‹ä¸€æ­¥"
8. éªŒè¯é€šè¿‡ âœ…ï¼ˆå› ä¸º Gas è´¹ç”¨æ²¡æœ‰å˜åŒ–ï¼‰

### åœºæ™¯3ï¼šç‚¹å‡»"å…¨éƒ¨"åä¿®æ”¹é‡‘é¢

1. ç”¨æˆ·ç‚¹å‡»"å…¨éƒ¨"
2. Gas è´¹ç”¨è¢«é”å®š ğŸ”’
3. ç”¨æˆ·ä¿®æ”¹é‡‘é¢
4. **Gas è´¹ç”¨è§£é”** ğŸ”“
5. Gas è´¹ç”¨é‡æ–°å¼€å§‹åˆ·æ–° âœ…
6. ç”¨æˆ·ç‚¹å‡»"ä¸‹ä¸€æ­¥"
7. éªŒè¯é€šè¿‡ âœ…

## ä¼˜åŠ¿

### 1. è§£å†³ä½™é¢ä¸è¶³é—®é¢˜
- ç‚¹å‡»"å…¨éƒ¨"å Gas è´¹ç”¨ä¸å˜
- ç¡®ä¿ é‡‘é¢ + Gasè´¹ = ä½™é¢
- éªŒè¯æ—¶ä¸ä¼šå‡ºç°ä½™é¢ä¸è¶³

### 2. ä¿æŒ Gas è´¹ç”¨å®æ—¶æ€§
- æ­£å¸¸è¾“å…¥æ—¶ Gas è´¹ç”¨ä»ç„¶è‡ªåŠ¨åˆ·æ–°
- ç”¨æˆ·ä¿®æ”¹é‡‘é¢å Gas è´¹ç”¨é‡æ–°åˆ·æ–°
- ä¸å½±å“æ­£å¸¸ä½¿ç”¨ä½“éªŒ

### 3. ç”¨æˆ·ä½“éªŒå¥½
- ç‚¹å‡»"å…¨éƒ¨"åç«‹å³å¯ä»¥å‘é€
- ä¸éœ€è¦æ‹…å¿ƒ Gas è´¹ç”¨å˜åŒ–
- å€’è®¡æ—¶åœæ­¢ï¼Œç”¨æˆ·çŸ¥é“ Gas å·²é”å®š

## è°ƒè¯•ä¿¡æ¯

### ç‚¹å‡»"å…¨éƒ¨"æ—¶

```
=== ç‚¹å‡»å…¨éƒ¨æŒ‰é’® ===
å½“å‰ä½™é¢: 0.25000000 (åŸå§‹: 0.25)
Gasè´¹ç”¨: 0.00000231 (åŸå§‹: 0.00000231)
æœ€å¤§é‡‘é¢: 0.24999769
éªŒè¯: æœ€å¤§é‡‘é¢ + Gas = 0.25000000
éªŒè¯: æ˜¯å¦ <= ä½™é¢? true
Gas è´¹ç”¨å·²é”å®š
```

### ç‚¹å‡»"ä¸‹ä¸€æ­¥"æ—¶

```
=== ä½™é¢éªŒè¯ ===
è¾“å…¥é‡‘é¢: 0.24999769
Gasè´¹ç”¨: 0.00000231
éœ€è¦æ€»é¢: 0.25000000
å½“å‰ä½™é¢: 0.25000000
ä½™é¢å……è¶³: true
```

## æµ‹è¯•æ­¥éª¤

### æµ‹è¯•1ï¼šæ­£å¸¸å‘é€
1. è¾“å…¥é‡‘é¢ 0.1
2. ç­‰å¾…10ç§’ï¼ˆè®© Gas åˆ·æ–°ï¼‰
3. ç‚¹å‡»"ä¸‹ä¸€æ­¥"
4. âœ… åº”è¯¥æˆåŠŸ

### æµ‹è¯•2ï¼šå…¨éƒ¨æŒ‰é’®
1. ç‚¹å‡»"å…¨éƒ¨"
2. è§‚å¯Ÿå€’è®¡æ—¶åœæ­¢
3. ç­‰å¾…10ç§’
4. ç‚¹å‡»"ä¸‹ä¸€æ­¥"
5. âœ… åº”è¯¥æˆåŠŸ

### æµ‹è¯•3ï¼šå…¨éƒ¨åä¿®æ”¹
1. ç‚¹å‡»"å…¨éƒ¨"
2. ä¿®æ”¹é‡‘é¢
3. è§‚å¯Ÿå€’è®¡æ—¶é‡æ–°å¼€å§‹
4. ç‚¹å‡»"ä¸‹ä¸€æ­¥"
5. âœ… åº”è¯¥æˆåŠŸ

### æµ‹è¯•4ï¼šGas è´¹ç”¨å˜åŒ–
1. ç‚¹å‡»"å…¨éƒ¨"
2. åœ¨æ§åˆ¶å°æ‰‹åŠ¨ä¿®æ”¹ Gas è´¹ç”¨ï¼ˆæ¨¡æ‹Ÿç½‘ç»œå˜åŒ–ï¼‰
3. ç‚¹å‡»"ä¸‹ä¸€æ­¥"
4. âœ… åº”è¯¥ä»ç„¶ä½¿ç”¨é”å®šçš„ Gas è´¹ç”¨

## ç›¸å…³æ–‡ä»¶

- `lib/screens/send_detail_screen.dart` - ä¸»è¦ä¿®æ”¹æ–‡ä»¶
- `lib/utils/amount_utils.dart` - Decimal è®¡ç®—å·¥å…·
- `DEBUG_BALANCE_ISSUE.md` - è°ƒè¯•æŒ‡å—

## åç»­ä¼˜åŒ–

### 1. æ·»åŠ è§†è§‰æç¤º

åœ¨ Gas è´¹ç”¨åŒºåŸŸæ·»åŠ é”å®šå›¾æ ‡ï¼š

```dart
Row(
  children: [
    Text('Gasè´¹'),
    if (_gasFeeLocked)
      Icon(Icons.lock, size: 14, color: Colors.amber),
    // ...
  ],
)
```

### 2. æ·»åŠ è§£é”æŒ‰é’®

å…è®¸ç”¨æˆ·æ‰‹åŠ¨è§£é” Gas è´¹ç”¨ï¼š

```dart
if (_gasFeeLocked)
  TextButton(
    onPressed: () {
      setState(() {
        _gasFeeLocked = false;
      });
      _loadGasFee();
    },
    child: Text('åˆ·æ–°Gas'),
  )
```

### 3. æ·»åŠ æç¤ºä¿¡æ¯

```dart
if (_gasFeeLocked)
  Text(
    'Gasè´¹ç”¨å·²é”å®šï¼Œç¡®ä¿ä½™é¢å……è¶³',
    style: TextStyle(color: Colors.amber, fontSize: 12),
  )
```

## æ€»ç»“

âœ… **é—®é¢˜å·²è§£å†³**
- ç‚¹å‡»"å…¨éƒ¨"å Gas è´¹ç”¨è¢«é”å®š
- ä¸ä¼šå› ä¸º Gas å˜åŒ–å¯¼è‡´ä½™é¢ä¸è¶³
- ç”¨æˆ·ä¿®æ”¹é‡‘é¢åè‡ªåŠ¨è§£é”

ğŸ¯ **æ ¸å¿ƒæœºåˆ¶**
- é”å®šæ ‡å¿—æ§åˆ¶ Gas åˆ·æ–°
- ç‚¹å‡»"å…¨éƒ¨"æ—¶é”å®š
- ä¿®æ”¹é‡‘é¢æ—¶è§£é”

ğŸ“ **ç”¨æˆ·ä½“éªŒ**
- ç‚¹å‡»"å…¨éƒ¨"åå¯ä»¥ç«‹å³å‘é€
- ä¸éœ€è¦æ‹…å¿ƒ Gas å˜åŒ–
- æ­£å¸¸ä½¿ç”¨ä¸å—å½±å“

---

**ä¿®å¤è€…**: Kiro AI Assistant  
**ä¿®å¤æ—¥æœŸ**: 2025-10-14  
**ç‰ˆæœ¬**: 3.1.0
